node('ROCK360'){
    dir('/home/rk/peter/openai_jenkins_file'){
        stage(' git pull jenkins file'){
            sh "pwd"
            sh '''#!/bin/bash
                    git pull
            '''

        }
    }

    dir('/home/rk/tengine'){
        stage('Git Pull'){
            sh "pwd"
            sh "hostname"
            sh '''#!/bin/bash
 #                   git pull
            '''
        }
        stage('Make'){

            sh '''#!/bin/bash
                    #make clean
                    make -j4
                    make install
            '''
        }
        stage('Make example'){

            sh '''#!/bin/bash
                mkdir -p build/examples
                rm -rf build/examples/*
                cd build/examples && cmake -DTENGINE_DIR=/home/rk/tengine ../../examples/ && make -j4
            '''
        }
        stage(' Run SqueezeNet'){

            sh '''#!/bin/bash
                    ./build/tests/bin/bench_sqz -r1
            '''
        }

        stage(' Run bench_mobilenet'){

            sh '''#!/bin/bash
                    ./build/tests/bin/bench_mobilenet -r1
            '''
        }
        stage(' Create Convate'){
            print 'Create squeezenet'
            sh '''#!/bin/bash
                    rm -rf models/*.tmfile
                    ./build/tools/bin/convert_model_to_tm -f caffe -p models/sqz.prototxt -m models/squeezenet_v1.1.caffemodel -o models/squeezenet.tmfile

            '''
             print 'Create mobilenet'
             sh '''#!/bin/bash
                    ./build/tools/bin/convert_model_to_tm -f caffe -p models/mobilenet_deploy.prototxt -m models/mobilenet.caffemodel -o models/mobilenet.tmfile

            '''
             print 'Create resnet50'
             sh '''#!/bin/bash
                    ./build/tools/bin/convert_model_to_tm -f caffe -p models/resnet50.prototxt -m models/resnet50.caffemodel -o models/resnet50.tmfile

            '''
             print 'Create googlenet'
             sh '''#!/bin/bash
                    ./build/tools/bin/convert_model_to_tm -f caffe -p models/googlenet.prototxt -m models/googlenet.caffemodel -o models/googlenet.tmfile

            '''
             print 'Create inception_v4'
             sh '''#!/bin/bash
                    ./build/tools/bin/convert_model_to_tm -f caffe -p models/inception_v4.prototxt -m models/inception_v4.caffemodel -o models/inception_v4.tmfile

             '''
             print 'Create inception_v3'
             sh '''#!/bin/bash
                    ./build/tools/bin/convert_model_to_tm -f caffe -p models/deploy_inceptionV3.prototxt -m models/deploy_inceptionV3.caffemodel -o models/inception_v3.tmfile

            '''
             print 'Create alexnet'
             sh '''#!/bin/bash
                    ./build/tools/bin/convert_model_to_tm -f caffe -p models/alex_deploy.prototxt -m models/alexnet.caffemodel -o models/alexnet.tmfile

            '''
             print 'Create vgg16'
             sh '''#!/bin/bash
#                    ./build/tools/bin/convert_model_to_tm -f caffe -p models/vgg16.prototxt -m models/vgg16.caffemodel -o models/vgg16.tmfile

            '''

        }

        stage(' Run Convate'){
			sh '''#!/bin/bash
				make install
				cd examples/tengine_model/classification
				cmake -DTENGINE_DIR=/home/rk/tengine .
				make

			'''
			print 'Run squeezenet'
			sh '''#!/bin/bash
				./examples/tengine_model/classification/tm_classify -n squeezenet

			'''
			print 'Run mobilenet'
			sh '''#!/bin/bash
				./examples/tengine_model/classification/tm_classify -n mobilenet

			'''
			print 'Run resnet50'
			sh '''#!/bin/bash
				./examples/tengine_model/classification/tm_classify -n mobilenet

			'''
			print 'Run googlenet'
			sh '''#!/bin/bash
				./examples/tengine_model/classification/tm_classify -n googlenet

			'''
			print 'Run inception_v4'
			sh '''#!/bin/bash
				./examples/tengine_model/classification/tm_classify -n inception_v4

			'''
			print 'Run inception_v3'
			sh '''#!/bin/bash
				./examples/tengine_model/classification/tm_classify -n inception_v3

			'''
			print 'Run alexnet'
			sh '''#!/bin/bash
				./examples/tengine_model/classification/tm_classify -n alexnet

			'''
			print 'Run vgg16'
			sh '''#!/bin/bash
#           	./examples/tengine_model/classification/tm_classify -n vgg16 -i tests/images/bike.jpg

			'''

		}

    }

    dir('/home/rk/peter/openai_jenkins_file'){
        stage(' Run Jenkins/test'){
            sh "pwd"
            sh "hostname"
            sh '''#!/bin/bash
                    git pull
                    pytest test.py -k "not test_eval_android" --cmdopt="onboard" --targetdir="/home/rk/tengine" --variables=./test_var.json --html=report/test.html --junit-xml=report/test.xml --verbose || true
            '''
            junit allowEmptyResults: true, keepLongStdio: true, testResults: 'report/test.xml'
            publishHTML([allowMissing: true, alwaysLinkToLastBuild: true, keepAll: true, reportDir: 'report/', reportFiles: 'test.html', reportName: 'HTML Report', reportTitles: ''])
        }
    }
    dir('/home/rk/tengine/examples/build/imagenet_classification/'){

        stage('squeezenet_FP32_1xA72'){

			sh '''#!/bin/bash
				export TENGINE_CPU_LIST=5
				export CONV_INT_PRIO=2000
				sleep 2
                ./Classify -n squeezenet -r 100 & mpstat -P ALL 1 5
                sleep 10

			'''
		}

        stage('squeezenet_Int8_1xA72'){

			sh '''#!/bin/bash
				export CONV_INT_PRIO=200
				sleep 2
				 ./Classify -n squeezenet -r 100 & mpstat -P ALL 1 5
				 sleep 10

			'''

		}

        stage('squeezenet_FP32_2xA72'){

			sh '''#!/bin/bash
				export TENGINE_CPU_LIST=4,5
				export CONV_INT_PRIO=2000
				./Classify -n squeezenet -r 100 & sleep 10 & mpstat -P ALL 1 5

			'''

		}
        stage('squeezenet_Int8_2xA72'){

			sh '''#!/bin/bash
				export CONV_INT_PRIO=200
                ./Classify -n squeezenet -r 100 & sleep 10 & mpstat -P ALL 1 5

			'''


		}

        stage('squeezenet_FP32_1xA53'){

			sh '''#!/bin/bash
				export TENGINE_CPU_LIST=2
				export CONV_INT_PRIO=2000
				./Classify -n squeezenet -r 100 & sleep 10 & mpstat -P ALL 1 5

			'''


		}
        stage('Squeezenet_Int8_1xA53'){

			sh '''#!/bin/bash
				export CONV_INT_PRIO=200
				./Classify -n squeezenet -r 100 & sleep 10 & mpstat -P ALL 1 5

			'''

		}
        stage('squeezenet_FP32_4xA53'){

			sh '''#!/bin/bash
				export TENGINE_CPU_LIST=0,1,2,3
				export CONV_INT_PRIO=2000
                ./Classify -n squeezenet -r 100 & sleep 10 & mpstat -P ALL 1 5

			'''

		}
        stage('squeezenet_Int8_4xA53'){

			sh '''#!/bin/bash
				export CONV_INT_PRIO=200
				./Classify -n squeezenet -r 100 & sleep 10 & mpstat -P ALL 1 5

			'''

		}
        stage('mobilenet_FP32_1xA72'){

			sh '''#!/bin/bash
				export TENGINE_CPU_LIST=5
				export CONV_INT_PRIO=2000
				./Classify -n mobilenet -r 100 & sleep 10 & mpstat -P ALL 1 5

			'''
		}

        stage('mobilenet_Int8_1xA72'){

			sh '''#!/bin/bash
				export CONV_INT_PRIO=200
				./Classify -n mobilenet -r 100 & sleep 10 & mpstat -P ALL 1 5

			'''

		}

        stage('mobilenet_FP32_2xA72'){

			sh '''#!/bin/bash
				export TENGINE_CPU_LIST=4,5
				export CONV_INT_PRIO=2000
                ./Classify -n mobilenet -r 100 & sleep 10 & mpstat -P ALL 1 5

			'''

		}
        stage('mobilenet_Int8_2xA72'){

			sh '''#!/bin/bash
				export CONV_INT_PRIO=200
				./Classify -n mobilenet -r 100 & sleep 10 & mpstat -P ALL 1 5

			'''

		}

        stage('mobilenet_FP32_1xA53'){

			sh '''#!/bin/bash
				export TENGINE_CPU_LIST=2
				export CONV_INT_PRIO=2000
				./Classify -n mobilenet -r 100 & sleep 10 & mpstat -P ALL 1 5

			'''

		}
        stage('mobilenet_Int8_1xA53'){

			sh '''#!/bin/bash
				export CONV_INT_PRIO=200
				./Classify -n mobilenet -r 100 & sleep 10 & mpstat -P ALL 1 5

			'''

		}
        stage('mobilenet_FP32_4xA53'){

			sh '''#!/bin/bash
				export TENGINE_CPU_LIST=0,1,2,3
				export CONV_INT_PRIO=2000
				./Classify -n mobilenet -r 100 & sleep 10 & mpstat -P ALL 1 5

			'''

		}
        stage('mobilenet_Int8_4xA53'){

			sh '''#!/bin/bash
				export CONV_INT_PRIO=200
				./Classify -n mobilenet -r 100 & sleep 10 & mpstat -P ALL 1 5

			'''
		}

	}
}